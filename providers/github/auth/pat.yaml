version: "1.0"
provider:
  name: "github"
  providerType: "pat"
  flows:
    PAT:
      startAt: "ValidateToken"
      states:
        ValidateToken:
          type: "task"
          resource: "http.request"
          parameters:
            method: "GET"
            url: "https://api.github.com/user"
            headers:
              Authorization: "{% 'token ' & vars.secrets.github_token %}"
              Accept: "application/vnd.github+json"
              User-Agent: "openact/1.0"
            trace: true
          assign:
            user_login: "{% result.body.login %}"
            user_id: "{% result.body.id %}"
            user_name: "{% result.body.name %}"
          next: "PersistConnection"
        
        PersistConnection:
          type: "task"
          resource: "connection.update"
          parameters:
            tenant:
              $expr: "input.tenant ? input.tenant : 'default'"
            provider: "github"
            user_id: "{% $user_login ? $user_login : 'unknown' %}"
            access_token: "{% vars.secrets.github_token %}"
            token_type: "token"
            scope: ""
            extra:
              user_name: "{% $user_name %}"
              user_id: "{% $user_id %}"
          end: true
