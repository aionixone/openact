{
  "version": "1.0",
  "provider": {
    "name": "github",
    "providerType": "oauth2",
    "flows": {
      "OAuth": {
        "startAt": "Config",
        "states": {
          "Config": {
            "type": "pass",
            "assign": {
              "config": {
                "authorizeUrl": "https://github.com/login/oauth/authorize",
                "tokenUrl": "https://github.com/login/oauth/access_token",
                "redirectUri": "{% input.redirectUri ? input.redirectUri : 'http://localhost:8080/oauth/callback' %}",
                "defaultScope": "{% input.scope ? input.scope : 'user:email' %}"
              },
              "creds": {
                "client_id": "{% vars.secrets.github_client_id %}",
                "client_secret": "{% vars.secrets.github_client_secret %}"
              }
            },
            "next": "StartAuth"
          },
          "StartAuth": {
            "type": "task",
            "resource": "oauth2.authorize_redirect",
            "parameters": {
              "authorizeUrl": "{% $config.authorizeUrl %}",
              "clientId": "{% $creds.client_id %}",
              "redirectUri": "{% $config.redirectUri %}",
              "scope": "{% $config.defaultScope %}",
              "usePKCE": true
            },
            "assign": {
              "meta": {
                "oauth": {
                  "expected_state": "{% result.state %}",
                  "code_verifier": "{% result.code_verifier %}"
                }
              }
            },
            "next": "AwaitCallback"
          },
          "AwaitCallback": {
            "type": "task",
            "resource": "oauth2.await_callback",
            "assign": {
              "callback_code": "{% result.code %}"
            },
            "next": "ExchangeToken"
          },
          "ExchangeToken": {
            "type": "task",
            "resource": "http.request",
            "parameters": {
              "method": "POST",
              "url": "{% $config.tokenUrl %}",
              "headers": {
                "Content-Type": "application/x-www-form-urlencoded",
                "Accept": "application/json"
              },
              "trace": true,
              "body": {
                "grant_type": "authorization_code",
                "client_id": "{% $creds.client_id %}",
                "client_secret": "{% $creds.client_secret %}",
                "redirect_uri": "{% $config.redirectUri %}",
                "code": "{% $callback_code %}",
                "code_verifier": "{% $code_verifier %}"
              }
            },
            "assign": {
              "access_token": "{% result.body.access_token %}",
              "refresh_token": "{% result.body.refresh_token %}",
              "token_type": "{% result.body.token_type %}",
              "scope": "{% result.body.scope %}"
            },
            "output": {
              "access_token": "{% $access_token %}",
              "refresh_token": "{% $refresh_token ? $refresh_token : null %}",
              "token_type": "{% $token_type ? $token_type : 'bearer' %}",
              "scope": "{% $scope ? $scope : '' %}",
              "expires_in": "{% $expires_in ? $expires_in : null %}"
            },
            "next": "GetUser"
          },
          "GetUser": {
            "type": "task",
            "resource": "http.request",
            "parameters": {
              "method": "GET",
              "url": "https://api.github.com/user",
              "headers": {
                "Authorization": "{% 'Bearer ' & $access_token %}",
                "Accept": "application/vnd.github+json",
                "User-Agent": "authflow/0.1"
              },
              "trace": true
            },
            "assign": {
              "user_login": "{% result.body.login %}"
            },
            "next": "PersistConnection"
          },
          "PersistConnection": {
            "type": "task",
            "resource": "connection.update",
            "parameters": {
              "tenant": { "$expr": "input.tenant ? input.tenant : 'default'" },
              "provider": "github",
              "user_id": "{% $user_login ? $user_login : 'unknown' %}",
              "access_token": "{% $access_token %}",
              "refresh_token": "{% $refresh_token %}",
              "token_type": "{% $token_type %}",
              "scope": "{% $scope %}",
              "expires_in": "{% $expires_in %}",
              "extra": "{% $raw_response %}"
            },
            "end": true
          }
        }
      }
    }
  }
}