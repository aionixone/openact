{
  "comment": "GitHub OAuth2 (pure stepflow)",
  "startAt": "Config",
  "states": {
    "Config": {
      "type": "pass",
      "assign": {
        "config.authorizeUrl": "https://github.com/login/oauth/authorize",
        "config.tokenUrl": "https://github.com/login/oauth/access_token",
        "config.userInfoUrl": "https://api.github.com/user",
        "config.redirectUri": "{% input.redirectUri ? input.redirectUri : 'http://localhost:8080/oauth/callback' %}",
        "config.scope": "{% input.scope ? input.scope : 'user:email' %}",
        "config.userAgent": "openact/0.1"
      },
      "next": "StartAuth"
    },
    "StartAuth": {
      "type": "task",
      "resource": "oauth2.authorize_redirect",
      "parameters": {
        "authorizeUrl": "{% $config.authorizeUrl %}",
        "clientId": "{% input.clientId %}",
        "redirectUri": "{% $config.redirectUri %}",
        "scope": "{% $config.scope %}",
        "usePKCE": true
      },
      "assign": {
        "auth": {
          "authorize_url": "{% result.authorize_url %}",
          "state": "{% result.state %}",
          "code_verifier": "{% result.code_verifier %}"
        }
      },
      "next": "Await"
    },
    "Await": {
      "type": "task",
      "resource": "oauth2.await_callback",
      "parameters": {
        "expected_state": "{% $auth.state %}",
        "expected_pkce": {
          "code_verifier": "{% $auth.code_verifier %}"
        }
      },
      "assign": {
        "auth": { "code": "{% result.code %}" }
      },
      "next": "Exchange"
    },
    "Exchange": {
      "type": "task",
      "resource": "http.request",
      "parameters": {
        "method": "POST",
        "url": "{% $config.tokenUrl %}",
        "headers": {
          "Content-Type": "application/x-www-form-urlencoded",
          "Accept": "application/json"
        },
        "body": {
          "grant_type": "authorization_code",
          "client_id": "{% input.clientId %}",
          "client_secret": "{% input.clientSecret %}",
          "redirect_uri": "{% $config.redirectUri %}",
          "code": "{% $auth.code %}",
          "code_verifier": "{% $auth.code_verifier %}"
        }
      },
      "assign": {
        "oauth": {
          "access_token": "{% result.body.access_token %}",
          "refresh_token": "{% result.body.refresh_token %}",
          "token_type": "{% result.body.token_type %}",
          "scope": "{% result.body.scope %}",
          "expires_in": "{% result.body.expires_in %}"
        }
      },
      "next": "GetUser"
    },
    "GetUser": {
      "type": "task",
      "resource": "http.request",
      "parameters": {
        "method": "GET",
        "url": "{% $config.userInfoUrl %}",
        "headers": {
          "Authorization": "{% 'Bearer ' & $oauth.access_token %}",
          "Accept": "application/vnd.github+json",
          "User-Agent": "{% $config.userAgent %}"
        }
      },
      "assign": {
        "user": { "login": "{% result.body.login %}" }
      },
      "next": "Persist"
    },
    "Persist": {
      "type": "task",
      "resource": "connection.update",
      "parameters": {
        "connection_ref": "{% (input.tenant ? input.tenant : 'default') & ':github:' & ($user.login ? $user.login : 'unknown') %}",
        "access_token": "{% $oauth.access_token %}",
        "refresh_token": "{% $oauth.refresh_token %}",
        "expires_in": "{% $oauth.expires_in %}"
      },
      "end": true
    }
  }
}
